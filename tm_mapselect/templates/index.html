<!DOCTYPE html>
<html>

<head>
  <title>Trackmania Map Selector - {{ state.server_name }}</title>
  <style>
    body {
      background-image: linear-gradient(to bottom right, #1da153, #48a9ca);
      background-attachment: fixed;
      text-transform: uppercase;
    }

    #maps {
      background-color: rgba(0, 0, 0, 0.3);
      overflow-y: auto;
    }

    #maplist {
      display: flex;
      height: 70vh;
      flex-wrap: wrap;
      flex-direction: column;
      gap: 0px;
      transform: skew(-5deg);
      z-index: 0;
    }

    #maps li.mapwindow {
      display: flex;
      position: relative;
      height: 15%;
      width: 20%;
      margin: 10px;
      flex: 1 0 auto;
      color: white;
      font-size: 24px;
      font-family: sans-serif;
      font-weight: 1000;
      text-shadow: 2px 2px 4px #000000;
      text-align: center;
      align-content: center;
    }

    .maptile {
      display: flex;
      position: relative;
      background-size: cover;
      background-position: center;
      transition: transform .2s;
      box-sizing: border-box;
      flex: auto;
      z-index: 1;
      border-radius: 15px 0px 15px 0px;
    }

    #maps .current-map {
      border: 5px solid #6efaa0;
      /* box-shadow: 0 0 30px 15px rgba(255, 255, 255, 0.7); */
    }

    #maps .current-map:hover {
      /* box-shadow: 0 0 30px 15px rgba(110, 250, 160, 0.7); */
    }

    #maps .maptile:hover {
      cursor: pointer;
      transform: scale(1.1);
      border: 5px solid white;
      z-index: 3;
    }

    .top_bar {
      transform: skew(-5deg);
      width: 100%;
      position: relative;
      height: fit-content;
      padding: 10px 0px;
    }


    .top_bar a,
    .top_bar span {
      transform: skew(5deg);
    }

    .top_bar input[type="text"] {
      border-radius: 15px 0px 0px 0px;
      padding: 10px 0px 10px 20px;
      width: fit-content;
      background-color: #047f4f;
      color: #9acdb7;
      font-size: 20px;
      font-family: sans-serif;
      font-weight: 600;
      border: none;
    }

    .top_bar input[type="checkbox"] {
      display: none;
      visibility: hidden;
    }

    .top_bar input[type="checkbox"]:checked+.checkbox_label_right {
      background-color: #006644;
      color: #ffffff;
    }

    .top_bar .checkbox_label_right:hover {
      background-color: #009b5f;
      color: #ffffff;
      cursor: pointer;
    }

    .top_bar .checkbox_label_right {
      background-color: #047f4f;
      color: #b5d3c6;
      font-size: 20px;
      font-family: sans-serif;
      font-weight: 600;
      padding: 10px 20px;
      border-radius: 0px 0px 15px 0px;
      cursor: pointer;
    }

    .top_bar .right_area {
      position: absolute;
      right: 0px;
      top: 0px;
      width: fit-content;
    }

    #maps .mapstext {
      transform: skew(5deg);
      display: block;
      flex: auto;
      padding-top: 10px;
    }


    #maps .usertime {
      position: absolute;
      bottom: 5px;
      right: 10px;
      background-color: rgba(0, 0, 0, 0.6);
      padding: 0px 10px 5px 10px;
      border-radius: 10px;
      font-size: 18px;
      font-family: sans-serif;
      font-weight: 700;
    }

    h1 {
      color: white;
      font-size: 48px;
      font-family: sans-serif;
      font-weight: 1000;
      text-shadow: 2px 2px 4px #000000;
      text-align: center;
    }

    h2 {
      color: white;
      font-size: 32px;
      font-family: sans-serif;
      font-weight: 600;
      text-align: center;
    }

    .options {
      transform: skew(-5deg);
      max-width: 100em;
      margin: 20px auto;
    }

    .options label,
    .label_left {
      display: inline-block;
      background-color: rgba(0, 5, 20, 0.6);
      color: #a0a7a8;
      padding: 10px 20px;
      width: 60%;
      font-size: 20px;
      font-family: sans-serif;
      font-weight: 700;
      text-transform: uppercase;
      border-radius: 15px 0px 0px 0px;
      box-sizing: border-box;
    }

    .options .tm_stat {
      display: inline-block;
    }

    .options input,
    .options .tm_stat,
    .input_right {
      margin: 5px 0px 0px 0px;
    }

    .options label:hover {
      background-color: rgba(0, 5, 20, 1);
      color: #6efaa0;
    }

    .options input:hover,
    .options input:focus,
    .options .tm_stat:hover,
    .options .connected_elements label:hover+.tm_stat,
    .input_right:hover {
      background-color: #009b5f;
      color: #ffffff;
      cursor: text;
    }

    .options input,
    .options .tm_stat,
    .input_right {
      background-color: #047f4f;
      color: #9acdb7;
      font-size: 20px;
      font-family: sans-serif;
      font-weight: 600;
      padding: 10px;
      width: 40%;
      border: none;
      border-radius: 0px 0px 15px 0px;
      box-sizing: border-box;
    }

    input[type="checkbox"].input_right {
      padding: 10px 20px;
      border-radius: 0px 15px 0px 0px;
    }

    .options input[type="submit"],
    .button,
    .button_left,
    .button_right {
      background-color: #02261f;
      color: #43a56c;
      font-size: 20px;
      font-family: sans-serif;
      font-weight: 600;
      border: none;
      padding: 10px 20px;
      border-radius: 15px 0px 15px 0px;
      text-decoration: none;
    }

    .button_left {
      border-radius: 15px 0px 0px 0px;
    }

    .button_right {
      border-radius: 0px 0px 15px 0px;
      background-color: #047f4f;
      color: #9acdb7;
    }


    .options input[type="submit"] {
      width: 100%;
      box-sizing: border-box;
    }

    .options input[type="submit"]:hover,
    .button:hover,
    .button_left:hover {
      background-color: rgba(0, 0, 0, 1);
      color: #6efaa0;
      border: 4px solid #6efaa0;
      padding: 6px 16px;
      box-sizing: border-box;
    }

    .medal {
      position: relative;
      height: 22px;
      top: 5px;
    }

    .medal-Author:before {
      content: "üèÜ";
    }

    .medal-Gold:before {
      content: "ü•á";
    }

    .medal-Silver:before {
      content: "ü•à";
    }

    .medal-Bronze:before {
      content: "ü•â";
    }

    .medal-None {
      display: none;
    }

    .medal-tooltip {
      visibility: hidden;
      width: max-content;
      height: 100%;
      position: absolute;
      top: 0%;
      left: 50%;
      font-size: 16px;
      transition: left 0.5s ease-in-out, transform 0.2s;
      background-color: #02261f;
      opacity: 0.9;
      border-radius: 15px 0px 15px 0px;
      display: flex;
      align-items: center;
      z-index: 0;
    }

    .medal-tooltip ul {
      list-style-type: none;
      padding: 0px 15px 0px 40px;
    }

    .maptile:hover+.medal-tooltip {
      visibility: visible;
      left: 100%;
      transform: scale(1.1);
      z-index: 2;
    }
  </style>

  <script>
    function jumpToMap(index) {
      fetch('/jumpToMap/' + index, {method: 'GET'})
        .then(response => {
          if (response.ok) {
            console.log('Jumped to map index: ' + index);
          } else {
            console.error('Failed to jump to map index: ' + index);
          }
        })
        .catch(error => {
          console.error('Error:', error);
        });
    }

    function applySettings() {
      const formElement = document.getElementById('settingsForm');
      const data = new FormData(formElement);
      fetch('/settings', {
        method: 'POST',
        body: data
      })
    }

    function filter_maplist() {
      const search_term = document.getElementById('map_search').value;
      const hide_completed = document.getElementById('hide_completed').checked;
      const maplist = document.getElementById('maplist');
      const maps = maplist.getElementsByClassName('mapwindow');
      for (let i = 0; i < maps.length; i++) {
        const mapNameElement = maps[i].querySelector('.clean_mapstext');
        const mapName = mapNameElement.textContent;
        if (mapName.toLowerCase().indexOf(search_term.toLowerCase()) > -1 &&
          (!hide_completed || !maps[i].querySelector('.usertime'))) {
          maps[i].style.display = '';
        } else {
          maps[i].style.display = 'none';
        }
      }
    }

  </script>
</head>

<body>
  <h1>Trackmania Map Selector - {{ state.server_name }}</h1>
  <div class="top_bar">{%- if user_name %}
    <a class="button_left" href="/logout">Logout</a><span class="button_right">Logged in as {{ user_name }}</span>
    {% else %}
    <a class="button" href="{{ authorization_url }}">Login with Trackmania</a>
    {% endif %}
    <span class="right_area">
      <input type="text" id="map_search" name="map_search" placeholder="Filter Maps..."
        onkeyup="filter_maplist()"><input type="checkbox" id="hide_completed" name="hide_completed"
        onchange="filter_maplist()" /><label for="hide_completed" class="checkbox_label_right">Hide Completed
        Maps</label>
    </span>
  </div>
  <div id='maps'>
    <ul id='maplist'>

      {% for map in state.maps %}

      <li class="mapwindow" onclick='jumpToMap({{ loop.index - 1 }})' {% if (loop.index - 1)==state.current_map_index %}
        class="current-map" {% endif %}>
        <div class="maptile" style="background-image: url('https://trackmania.exchange/mapthumb/{{ map.ID }}');">
          <div class="mapstext" id="{{ map.ID}}">
            <span class="mapname">{{ map.Name | format_tm | safe }}</span>
            <span class="mapauthor">by {{ map.Author }}</span>
          </div>
          <div class="clean_mapstext" style="display: none;">{{ map.Name | format_tm_clean }} {{ map.Author |
            format_tm_clean }}</div>

          {% if map.OnlineID in records %}
          <div class="usertime">
            {% if records[map.OnlineID].medal %}
            <img src="{{ url_for('static', filename='medal-'  + records[map.OnlineID].medal + '.png')}}"
              class="medal" />
            {% endif %}
            {{- records[map.OnlineID].record | format_time }}
          </div>
          {% endif %}
        </div>

        <div class="medal-tooltip">
          <ul>
            <li><img src="{{ url_for('static', filename='medal-Author.png')}}" class="medal"> {{ map.Medals["Author"] |
              format_time }}</li>
            <li><img src="{{ url_for('static', filename='medal-Gold.png')}}" class="medal"> {{ map.Medals["Gold"] |
              format_time }}</li>
            <li><img src="{{ url_for('static', filename='medal-Silver.png')}}" class="medal"> {{ map.Medals["Silver"] |
              format_time }}</li>
            <li><img src="{{ url_for('static', filename='medal-Bronze.png')}}" class="medal"> {{ map.Medals["Bronze"] |
              format_time }}</li>
          </ul>
        </div>

      </li>

      {% endfor %}

    </ul>
  </div>
  <h2>Options and Stats</h2>
  <div class='options'>
    <form id='settingsForm' method="post" action="#" onsubmit="applySettings();return false">
      <div class="connected_elements">
        <label for='current_players'>Current Players</label><span class="tm_stat">{{state.players|length}}</span>
      </div>
      <div class="connected_elements">
        <label>Current Map</label><span class="tm_stat">{{ state.current_map.Name | format_tm | safe }}</span>
      </div>
      <div class="connected_elements">
        <label>Number of Maps loaded</label><span class="tm_stat">{{ state.maps|length }}</span>
        <div>
          <label for='time_limit'>Time Limit</label><input type='number' id='time_limit' name='time_limit'
            value="{{ state.modescript_settings.time_limit }}" required>
          <label for='max_players'>Maximum Players</label><input type='number' id='max_players' name='max_players'
            value="{{ state.max_players }}" required>
        </div>
        <input type='submit' value='Apply' onclick='applySettings()'>
    </form>
  </div>
</body>

</html>
